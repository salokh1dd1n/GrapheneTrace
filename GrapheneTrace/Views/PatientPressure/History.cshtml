@model GrapheneTrace.ViewModels.PressureHistoryViewModel
@using System.Globalization
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Pressure History";

    string selectedRange = ViewBag.SelectedRange as string ?? "24h";
    DateTime? selectedDate = Model.SelectedDate;
    string selectedDateLabel = selectedDate.HasValue
        ? selectedDate.Value.ToString("dd MMM yyyy")
        : "Latest available data";
    string selectedDateValue = selectedDate.HasValue
        ? selectedDate.Value.ToString("yyyy-MM-dd")
        : "";
}

<div class="container-fluid">
    <h2 class="mb-4">Pressure History</h2>

    <!-- RANGE + DATE SELECTOR -->
    <div class="card mb-3">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
            <form method="get"
                  asp-action="History"
                  asp-controller="PatientPressure"
                  class="d-flex flex-wrap align-items-center gap-2">

                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0">Time range:</label>
                    <select name="range" class="form-select form-select-sm" style="width:auto;">
                        @if (selectedRange == "1h")
                        {
                            <option value="1h" selected>Last 1 hour</option>
                        }
                        else
                        {
                            <option value="1h">Last 1 hour</option>
                        }

                        @if (selectedRange == "6h")
                        {
                            <option value="6h" selected>Last 6 hours</option>
                        }
                        else
                        {
                            <option value="6h">Last 6 hours</option>
                        }

                        @if (selectedRange == "24h")
                        {
                            <option value="24h" selected>Last 24 hours</option>
                        }
                        else
                        {
                            <option value="24h">Last 24 hours</option>
                        }
                    </select>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0">Date:</label>
                    <input type="date"
                           name="selectedDate"
                           class="form-control form-control-sm"
                           style="width:auto;"
                           value="@selectedDateValue"/>
                </div>

                <button type="submit" class="btn btn-sm btn-primary">
                    Apply
                </button>
            </form>

            <div class="ms-auto small text-muted text-end">
                @if (Model.Points != null && Model.Points.Count > 0)
                {
                    var first = Model.Points.First().Timestamp.ToLocalTime();
                    var last = Model.Points.Last().Timestamp.ToLocalTime();

                    <div>Showing data for: <strong>@selectedDateLabel</strong></div>

                    <div>
                        From @first.ToString("dd MMM yyyy HH:mm") –
                        @last.ToString("dd MMM yyyy HH:mm")
                    </div>
                }
                else
                {
                    <span>No data available for this period.</span>
                }
            </div>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Peak Pressure (mmHg)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentPeakPressure.ToString("0", CultureInfo.InvariantCulture)
                    </h3>
                    <small class="text-muted">Highest recent seat pressure.</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Contact Area (%)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentContactAreaPercent.ToString("0.0", CultureInfo.InvariantCulture)%
                    </h3>
                    <small class="text-muted">Portion of the mat under pressure.</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Risk Score (0–10)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentRiskScore.ToString("0.0", CultureInfo.InvariantCulture)/10
                    </h3>
                    <small class="text-muted">Combined pressure & contact risk indicator.</small>
                </div>
            </div>
        </div>
    </div>

    @if (Model.Points == null || Model.Points.Count == 0)
    {
        <div class="alert alert-info">
            No pressure data available yet for the selected date and time range.
        </div>
    }
    else
    {
        <div class="row">
            <!-- PEAK PRESSURE CHART -->
            <div class="col-lg-8 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Peak Pressure over Time (mmHg)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="peakPressureChart" style="width:100%; height:320px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- HEATMAP -->
            <div class="col-lg-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Latest Pressure Map</h5>
                        @if (Model.Points != null && Model.Points.Count > 0)
                        {
                            var last = Model.Points.Last().Timestamp.ToLocalTime();
                            <small class="text-muted">@last.ToString("dd MMM yyyy HH:mm")</small>
                        }
                    </div>
                    @{
                        // Precompute some values for the heatmap
                        var matrix = Model.LatestFrameMatrix;
                        bool hasFrame = matrix != null &&
                                        matrix.GetLength(0) > 0 &&
                                        matrix.GetLength(1) > 0;

                        int rows = 0;
                        int cols = 0;
                        int maxVal = 1;

                        if (hasFrame)
                        {
                            rows = matrix.GetLength(0);
                            cols = matrix.GetLength(1);

                            for (int y = 0; y < rows; y++)
                            {
                                for (int x = 0; x < cols; x++)
                                {
                                    if (matrix[y, x] > maxVal)
                                        maxVal = matrix[y, x];
                                }
                            }
                        }
                    }

                    <div class="card-body">
                        @if (!hasFrame)
                        {
                            <div class="text-muted">No frame available.</div>
                        }
                        else
                        {
                            <div class="heatmap-grid">
                                @for (int y = 0; y < rows; y++)
                                {
                                    for (int x = 0; x < cols; x++)
                                    {
                                        var v = matrix[y, x];
                                        double ratio = maxVal == 0 ? 0 : (double)v / maxVal;

                                        int r = 255;
                                        int g = 255 - (int)(180 * ratio);
                                        int b = 255 - (int)(255 * ratio);
                                        string color = $"rgb({r},{g},{b})";

                                        <div class="heat-cell"
                                             title="@v"
                                             style="background-color:@color;"></div>
                                    }
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">Low</small>
                                <div class="heat-legend-bar flex-grow-1 mx-2"></div>
                                <small class="text-muted">High</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
