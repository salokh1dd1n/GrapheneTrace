@model GrapheneTrace.ViewModels.PressureHistoryViewModel
@using System.Globalization

@{
ViewData["Title"] = "Pressure History";

string selectedRange = ViewBag.SelectedRange as string ?? "24h";
}

<div class="container-fluid">
    <h2 class="mb-4">Pressure History</h2>

    <!-- RANGE SELECTOR -->
    <div class="card mb-3">
        <div class="card-body d-flex align-items-center">
            <form method="get" asp-action="History" asp-controller="PatientPressure" class="d-flex align-items-center">
                <label class="form-label me-2 mb-0">Time range:</label>
                <select name="range" class="form-select form-select-sm" style="width:auto;">
                    <option value="1h"  selected="@(selectedRange == "1h"  ? "selected" : "")">Last 1 hour</option>
                    <option value="6h"  selected="@(selectedRange == "6h"  ? "selected" : "")">Last 6 hours</option>
                    <option value="24h" selected="@(selectedRange == "24h" ? "selected" : "")">Last 24 hours</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary ms-2">Apply</button>
            </form>

            <div class="ms-auto small text-muted">
                @if (Model.Points != null && Model.Points.Count > 0)
                {
                var first = Model.Points.First().Timestamp;
                var last  = Model.Points.Last().Timestamp;
                <span>Showing data from @first.ToLocalTime() to @last.ToLocalTime()</span>
                }
                else
                {
                <span>No data available for this period.</span>
                }
            </div>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Peak Pressure (mmHg)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentPeakPressure.ToString("0", CultureInfo.InvariantCulture)
                    </h3>
                    <small class="text-muted">Highest recent seat pressure.</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Contact Area (%)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentContactAreaPercent.ToString("0.0", CultureInfo.InvariantCulture)%
                    </h3>
                    <small class="text-muted">Portion of the mat under pressure.</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Risk Score (0â€“10)</h6>
                    <h3 class="mb-0">
                        @Model.CurrentRiskScore.ToString("0.0", CultureInfo.InvariantCulture)
                    </h3>
                    <small class="text-muted">Combined pressure & contact risk indicator.</small>
                </div>
            </div>
        </div>
    </div>

    @if (Model.Points == null || Model.Points.Count == 0)
    {
    <div class="alert alert-info">
        No pressure data available yet. Please upload some frames first.
    </div>
    }
    else
    {
    <div class="row">
        <!-- PEAK PRESSURE CHART -->
        <div class="col-lg-8 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Peak Pressure over Time (mmHg)</h5>
                </div>
                <div class="card-body">
                    <canvas id="peakPressureChart" style="width:100%; height:320px;"></canvas>
                </div>
            </div>
        </div>

        <!-- HEATMAP -->
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Latest Pressure Map</h5>
                    @if (Model.Points != null && Model.Points.Count > 0)
                    {
                    var last = Model.Points.Last().Timestamp;
                    <small class="text-muted">@last.ToLocalTime()</small>
                    }
                </div>
                <div class="card-body">
                    @{
                        int rows = Model.LatestFrameMatrix.GetLength(0);
                        int cols = Model.LatestFrameMatrix.GetLength(1);

                        int maxVal = 1;

                        // find max value for heat color scaling
                        for (int y = 0; y < rows; y++)
                        {
                            for (int x = 0; x < cols; x++)
                            {
                                if (Model.LatestFrameMatrix[y, x] > maxVal)
                                    maxVal = Model.LatestFrameMatrix[y, x];
                            }
                        }

                        // declare sb *before* using it
                        var sb = new System.Text.StringBuilder();
                        sb.Append("<div class='heatmap-grid'>");

                        for (int y = 0; y < rows; y++)
                        {
                            for (int x = 0; x < cols; x++)
                            {
                                int v = Model.LatestFrameMatrix[y, x];
                                double ratio = maxVal == 0 ? 0 : (double)v / maxVal;

                                int r = 255;
                                int g = 255 - (int)(180 * ratio);
                                int b = 255 - (int)(255 * ratio);

                                string color = $"rgb({r},{g},{b})";

                                sb.Append(
                                    $"<div class='heat-cell' title='{v}' style='background-color:{color};'></div>"
                                );
                            }
                        }

                        sb.Append("</div>");
                    }

                    @Html.Raw(sb.ToString())

                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">Low</small>
                        <div class="heat-legend-bar flex-grow-1 mx-2"></div>
                        <small class="text-muted">High</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>

<!-- SIMPLE STYLES FOR HEATMAP -->
<style>
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(32, 1fr);
        grid-auto-rows: 1fr;
        gap: 1px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        max-width: 320px;
        margin: 0 auto;
    }

    .heat-cell {
        width: 10px;
        height: 10px;
    }

    .heat-legend-bar {
        height: 10px;
        border-radius: 5px;
        background: linear-gradient(to right, #ffffff, #ffebc2, #ff6b6b);
    }
</style>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    (function () {
        var hasData = @((Model.Points != null && Model.Points.Count > 0) ? "true" : "false");
        if (!hasData) {
            return;
        }

        var labels = [];
        var peakData = [];

        @foreach (var p in Model.Points)
        {
        var t = p.Timestamp.ToLocalTime().ToString("HH:mm");
        var peak = p.PeakPressure.ToString("0.##", CultureInfo.InvariantCulture);

        @:labels.push("@t");
        @:peakData.push(@peak);
        }

        var ctx = document.getElementById('peakPressureChart');
        if (!ctx) return;

        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peak Pressure (mmHg)',
                    data: peakData,
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        min: 0,
                        max: 200,
                        title: {
                            display: true,
                            text: 'Peak Pressure (mmHg)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                return ctx.parsed.y.toFixed(1) + ' mmHg';
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
}